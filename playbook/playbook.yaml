---

- name: Deploy a web application
  hosts: db_and_web_servers
  tasks:
  - name:  Install all required dependencies
    become: Yes
    become_method: sudo
    become_user: root
    yum: 
      name: 
      - python3-pip
      - python3-wheel
      - python3-devel
      - "@Development tools"
      state: installed

  - name:  Install MySQL database
    become: Yes
    become_method: sudo
    become_user: root
    yum: 
      name: 
        - mysql
      state: installed

  - name: Install MySQL-server database
    become: Yes
    become_method: sudo
    become_user: root
    dnf:
      name:
       - mysql-server
      state: installed
    
  - name:  Start MySql Service
    become: Yes
    become_method: sudo
    become_user: root
    service: 
      name: mysqld
      state: started      
      enabled: yes

  - name: Install python Flask dependency
    become: Yes
    become_method: sudo
    become_user: root
    pip: 
      name: 
        - Flask
        - Flask-MySQL
        - PyMySQL
      state: present
      extra_args: -q

  - name:  Create application database
    become: Yes
    become_method: sudo
    become_user: root
    mysql_db: 
     name: employee_db 
     state: present

  - name: Create Database user
    become: Yes
    become_method: sudo
    become_user: root
    mysql_user: 
      name: db_user
      password: adam1234
      priv: '*.*:ALL,GRANT'
      state: present
      host: '%'

  - name: Copy source code
    become: Yes
    become_method: sudo
    become_user: root
    copy: 
      src: /opt/ansible/app.py
      dest: /opt/
      owner: osboxes
      group: osboxes
      mode: '0644'
    
  - name: Open ports 5000
    become: Yes
    become_method: sudo
    become_user: root
    shell: firewall-cmd --zone=public --permanent --add-port 5000/tcp >> log1.txt

  - name: Open ports 5000
    become: Yes
    become_method: sudo
    become_user: root
    shell: firewall-cmd --reload >> log2.txt

  - name: Start web server
    shell: FLASK_APP=/opt/app.py nohup flask run --host=0.0.0.0 &